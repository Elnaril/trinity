Move command decoding out of the event loop.
